<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SplitShare</title>
    <link rel="stylesheet" href="/static/css/session.css">
    <link rel="icon" type="image/png" href="/static/images/favicon40.png">
</head>
<body>

    <div class="back-button">
        <a href="{{ url_for('groups_list') }}" class="back-button-link">
            <button>Back</button>
        </a>
    </div>

    <div class="container">
        <h3 class="group-name">{{ room_info['group_name'] }}</h3>
        <h5 class="date">{{ created_at }}</h5>

        <div class="expense-list">
            {% if has_expenses %}
                {% for expense in expenses %}
                    <div class="expense-item" data-id="{{ expense.id }}">
                        <div class="price">{{ expense.amount }}</div>
                        <div class="item">{{ expense.description }}</div>
                        <div class="paid-by">Paid by: {{ expense.paid_by }}</div>
                        <button class="edit-expense">Edit</button>
                        <button class="remove-expense">Remove</button>
                    </div>
                {% endfor %}
            {% else %}
                <p>No expenses yet.</p>
            {% endif %}
        </div>

        <div class="button-container">
            <button class="add-expense">Add an expense</button>
        <a href="{{ url_for('settle') }}">
                <button class="settle-up">Settle up</button>
        </a>
        </div>

        <div class="end-session-container">
            <form action="{{ url_for('end_group', room_id=room_id) }}" method="post">
                <button class="end-session" type="submit">End Session</button>
            </form>
        </div>
    </div>

    <div id="add-expense-popup" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h3>Add an Expense</h3>
            <form id="add-expense-form" action="{{ url_for('mainF', room_id=room_id) }}" method="POST">
                <label for="description">Description:</label>
                <input type="text" id="description" name="description" required>

                <label for="amount">Amount:</label>
                <input type="number" id="amount" name="amount" step="0.01" required>

                <label for="paid-by">Paid by:</label>
                <select id="paid-by" name="paid-by" required>
                    {% for member in members %}
                        <option value="{{ member.username }}">{{ member.username }}</option>
                    {% endfor %}
                </select>
                
                <div id="custom-amount-container" style="display: none;">
                    <label for="custom-amount">Enter amount:</label>
                    <input type="number" id="custom-amount" name="custom-amount" step="0.01">
                </div>

                <button type="submit">Save</button>
            </form>
        </div>
    </div>

    <div id="edit-expense-popup" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h3>Edit Expense</h3>
            <form id="editExpenseForm" action="{{ url_for('mainF', room_id=room_id) }}" method="POST">
                <input type="hidden" name="expense_id" id="expense_id">
                <label for="edit_description">Enter description:</label>
                <input type="text" name="description" id="edit_description" required>
                
                <label for="edit_amount">Expense:</label>
                <input type="number" step="0.01" name="amount" id="edit_amount" required>

                <label for="edit_paid_by">Paid by:</label>
                <select name="paid_by" id="edit_paid_by" required>
                    {% for member in members %}
                        <option value="{{ member.username }}">{{ member.username }}</option>
                    {% endfor %}
                </select>
                
                <button type="submit">Update Expense</button>
                <button type="button" class="cancel-btn" id="cancelEditExpense">Cancel</button>
            </form>
        </div>
    </div>


    <div id="settle-details-popup" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h3>Settlement Details</h3>
            <form id="settle-form">
                <label for="payer">Paid by:</label>
                <select name="payer" id="payer" required>
                    {% for member in members %}
                        <option value="{{ member.username }}">{{ member.username }}</option>
                    {% endfor %}
                </select>
    
                <label for="recipient">Paid to:</label>
                <select name="recipient" id="recipient" required>
                    {% for member in members %}
                        <option value="{{ member.username }}">{{ member.username }}</option>
                    {% endfor %}
                </select>
    
                <label for="amount-paid">Amount:</label>
                <input type="number" id="amount-paid" name="amount-paid" step="0.01" required>
    
                <label for="date">Date:</label>
                <input type="date" id="date" name="date" required>
    
                <button type="submit">Save</button>
                <button type="button" id="cancel-settle-details">Cancel</button>
            </form>
        </div>
    </div>

    <script src="/static/js/add-expense.js"></script>
    <script>
        document.getElementById("add-expense-form").onsubmit = async function (e) {
            e.preventDefault();
    
            const description = document.getElementById("description").value;
            const amount = document.getElementById("amount").value;
            const paidBy = document.getElementById("paid-by").value;
            const roomId = {{ room_info['room_id'] }};  // Ensure room_id is passed correctly
    
            const response = await fetch(`/session/${roomId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ description, expense: amount, paid_by: paidBy }),
            });
    
            if (response.ok) {
                const newExpense = await response.json();
    
                // Create a new expense item element
                const expenseItem = document.createElement('div');
                expenseItem.className = 'expense-item';
                expenseItem.innerHTML = `
                    <div class="price">${newExpense.amount}</div>
                    <div class="item">${newExpense.description}</div>
                    <div class="paid-by">Paid by: ${newExpense.paid_by}</div>
                    <button class="edit-expense">Edit</button>
                    <button>Remove</button>
                `;
    
                // Add the new expense item to the expense list
                const expenseList = document.querySelector('.expense-list');
                expenseList.appendChild(expenseItem);
    
                // Close the popup and reset the form
                document.getElementById('add-expense-popup').style.display = 'none';
                document.getElementById('add-expense-form').reset();

                window.location.reload();

            } else {
                alert("Success!");
                window.location.reload();
            }
        };
    
        // Close the popup when clicking the close button
        document.querySelectorAll('.close').forEach(button => {
            button.onclick = function () {
                this.parentElement.parentElement.style.display = 'none';
            }
        });
    
        // Show the add expense popup when clicking the add expense button
        document.querySelector('.add-expense').onclick = function () {
            document.getElementById('add-expense-popup').style.display = 'block';
        };
    </script>    

</body>
</html>
