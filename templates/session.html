<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SplitShare</title>
    <link rel="stylesheet" href="/static/css/session.css">
    <link rel="icon" type="image/png" href="/static/images/favicon40.png">
</head>
<body>

    <div class="back-button">
        <a href="{{ url_for('groups_list') }}" class="back-button-link">
            <button>Back</button>
        </a>
    </div>

    <div class="container">
            <h3 class="group-name">{{ room_info['group_name'] }}</h3>
            <h5 class="Date">{{ created_at }}</h5>

            <div class="expense-list">
                {% if has_expenses %}
                    {% for expense in expenses %}
                        <div class="expense-item">
                            <div class="price">{{ expense.amount }}</div>
                            <div class="item">{{ expense.description }}</div>
                            <div class="paid-by">Paid by: {{ expense.paid_by }}</div>
                            <button class="edit-expense">Edit</button>
                            <button>Remove</button>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No expenses yet.</p>
                {% endif %}
            </div>

        <div class="button-container">
            <button class="add-expense">Add an expense</button>
            <button class="settle-up">Settle up</button>
        </div>

        <div class="end-session-container">
            <button class="end-session">End Session</button>
        </div>
    </div>

    <div id="add-expense-popup" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h3>Add an Expense</h3>
            <form id="add-expense-form">
                <label for="description">Description:</label>
                <input type="text" id="description" name="description" required>

                <label for="amount">Amount:</label>
                <input type="number" id="amount" name="amount" step="0.01" required>

                <label for="paid-by">Paid by:</label>
                <select id="paid-by" name="paid-by" required>
                    {% for member in members %}
                        <option value="{{ member.username }}">{{ member.username }}</option>
                    {% endfor %}
                </select>
                <div id="custom-amount-container" style="display: none;">
                    <label for="custom-amount">Enter amount:</label>
                    <input type="number" id="custom-amount" name="custom-amount" step="0.01">
                </div>

                <button type="submit">Save</button>
            </form>
        </div>
    </div>

    <div id="edit-expense-popup" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h3>Edit Expense</h3>
            <form id="edit-expense-form">
                <input type="hidden" id="edit-expense-id">
                <label for="edit-description">Description:</label>
                <input type="text" id="edit-description" name="description" required>
    
                <label for="edit-amount">Amount:</label>
                <input type="number" id="edit-amount" name="amount" step="0.01" required>
    
                <label for="edit-paid-by">Paid by:</label>
                <select id="edit-paid-by" name="paid-by" required></select>
    
                <button type="submit">Save Changes</button>
                <button type="button" id="cancel-edit-expense">Cancel</button>
            </form>
        </div>
    </div>

    <div id="custom-amount-popup" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h3>Custom Split Amount</h3>
            <form id="custom-amount-form">
                <label for="custom-amount">Enter amount:</label>
                <input type="number" id="custom-amount" name="custom-amount" step="0.01" required>

                <button type="submit">Save</button>
                <button type="button" id="cancel-custom-amount">Cancel</button>
            </form>
        </div>
    </div>

    <div id="settle-method-popup" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h3>Choose Payment Method</h3>
            <button id="cash">Cash</button>
            <button id="e-wallet">E-wallet</button>
        </div>
    </div>

    <div id="settle-details-popup" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h3>Settlement Details</h3>
            <form id="settle-details-form">
                <label for="settle-paid-by">Paid by:</label>
                <select id="settle-paid-by" name="paid-by" required></select>

                <label for="settle-paid-to">Paid to:</label>
                <select id="settle-paid-to" name="paid-to" required></select>

                <label for="amount-paid">Amount:</label>
                <input type="number" id="amount-paid" name="amount-paid" step="0.01" required>

                <label for="date">Date:</label>
                <input type="date" id="date" name="date" required>

                <button type="submit">Save</button>
                <button type="button" id="cancel-settle-details">Cancel</button>
            </form>
        </div>
    </div>

    <script src="/static/js/add-expense.js"></script>
    <script>
        document.getElementById("add-expense-form").onsubmit = async function (e) {
            e.preventDefault();
    
            const description = document.getElementById("description").value;
            const amount = document.getElementById("amount").value;
            const paidBy = document.getElementById("paid-by").value;
            const roomId = {{ room_info['room_id'] }};  // Ensure room_id is passed correctly
    
            const response = await fetch(`/session/${roomId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ description, expense: amount, paid_by: paidBy }),
            });
    
            if (response.ok) {
                const newExpense = await response.json();
    
                // Create a new expense item element
                const expenseItem = document.createElement('div');
                expenseItem.className = 'expense-item';
                expenseItem.innerHTML = `
                    <div class="price">${newExpense.amount}</div>
                    <div class="item">${newExpense.description}</div>
                    <div class="paid-by">Paid by: ${newExpense.paid_by}</div>
                    <button class="edit-expense">Edit</button>
                    <button>Remove</button>
                `;
    
                // Add the new expense item to the expense list
                const expenseList = document.querySelector('.expense-list');
                expenseList.appendChild(expenseItem);
    
                // Close the popup and reset the form
                document.getElementById('add-expense-popup').style.display = 'none';
                document.getElementById('add-expense-form').reset();
            } else {
                alert("Failed to add expense.");
            }
        };
    
        // Close the popup when clicking the close button
        document.querySelectorAll('.close').forEach(button => {
            button.onclick = function () {
                this.parentElement.parentElement.style.display = 'none';
            }
        });
    
        // Show the add expense popup when clicking the add expense button
        document.querySelector('.add-expense').onclick = function () {
            document.getElementById('add-expense-popup').style.display = 'block';
        };
    </script>    
    

</body>
</html>
